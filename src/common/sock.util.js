const{getMessageById:getMessageById}=require("../db.repository/messages.repository"),{MessageTypes:MessageTypes,LegacyMessageTypes:LegacyMessageTypes,getLegacyMessageType:getLegacyMessageType}=require("./message.type"),{isUrl:isUrl}=require("./common.util"),MessageMedia=require("./message.media"),generateMessageId=()=>(new Date).getTime().toString(36)+Math.random().toString(36).slice(2),isRegisteredUser=async(e,s)=>{try{const[t]=await s.onWhatsApp(e);if(t)return t.exists}catch(e){console.log("error ...."),console.log(e)}return!1},sendTextAsync=async(e,s,t,a)=>{let n=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,a)){const o=await a.sendMessage(e,{text:s,mentions:t}),{key:r}=o;return r&&(n=r.id),`true_${e}_${s}_${n}`}return`false_${e}_${s}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${n}`},replyAsync=async(e,s,t,a)=>{let n=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,a)){const o=await getMessageById(t);if(console.log(`messageId: ${t}`),console.log(`json: ${o}`),!o)return`false_${e}_${s}_${n}`;const r=JSON.parse(o);if(!r)return`false_${e}_${s}_${n}`;const i=getLegacyMessageType(r);let g=void 0;console.log(`messageType: ${i}`),i===LegacyMessageTypes.CONVERSATION?g={conversation:r.message.conversation}:i===LegacyMessageTypes.IMAGE_MESSAGE?g=r.message.imageMessage.caption?{imageMessage:{mimetype:r.message.imageMessage.mimetype,caption:r.message.imageMessage.caption}}:{imageMessage:{mimetype:r.message.imageMessage.mimetype}}:i===LegacyMessageTypes.DOCUMENT_MESSAGE?g={documentMessage:{mimetype:r.message.documentMessage.mimetype,title:r.message.documentMessage.title}}:i===LegacyMessageTypes.VIDEO_MESSAGE?g={videoMessage:{mimetype:r.message.videoMessage.mimetype,fileSha256:r.message.videoMessage.fileSha256}}:i===LegacyMessageTypes.LOCATION_MESSAGE?g={locationMessage:{degreesLatitude:r.message.locationMessage.degreesLatitude,degreesLongitude:r.message.locationMessage.degreesLongitude}}:i===LegacyMessageTypes.BUTTONS_RESPONSE_MESSAGE?g={buttonsResponseMessage:{selectedButtonId:r.message.buttonsResponseMessage.selectedButtonId,selectedDisplayText:r.message.buttonsResponseMessage.selectedDisplayText}}:i===LegacyMessageTypes.LIST_RESPONSE_MESSAGE?g={listResponseMessage:{title:r.message.listResponseMessage.title}}:i===LegacyMessageTypes.CONTACT_MESSAGE?g={contactMessage:{displayName:r.message.contactMessage.displayName}}:i===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE&&(g={contactsArrayMessage:{displayName:r.message.contactsArrayMessage.displayName}});const c={key:r.key,message:g},l=await a.sendMessage(e,{text:s},{quoted:c}),{key:d}=l;return d&&(t=d.id),`true_${e}_${s}_${n}`}return`false_${e}_${s}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${n}`},sendImageAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){const r=isUrl(s)?await MessageMedia.fromUrl(s):MessageMedia.fromFilePath(s),i=await n.sendMessage(e,{image:r.data,caption:t||void 0,mentions:a}),{key:g}=i;return g&&(o=g.id),`true_${e}_${t}_${o}`}return`false_${e}_${t}_${o}`}catch(e){console.log(e)}return`false_${e}_${t}_${o}`},sendImageFromBufferAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){const r=await n.sendMessage(e,{image:s,caption:t||void 0,mentions:a}),{key:i}=r;return i&&(o=i.id),`true_${e}_${t}_${o}`}return`false_${e}_${t}_${o}`}catch(e){console.log(e)}return`false_${e}_${t}_${o}`},sendDocumentAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){const r=isUrl(s)?await MessageMedia.fromUrl(s):MessageMedia.fromFilePath(s),i=r.data,g=r.mimetype,c=r.filename,l=await n.sendMessage(e,{document:i,mimetype:g,fileName:c,mentions:a}),{key:d}=l;return d&&(o=d.id),`true_${e}_${t}_${o}`}return`false_${e}_${t}_${o}`}catch(e){console.log(e)}return`false_${e}_${t}_${o}`},sendDocumentFromBufferAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){const r=s.data,i=s.mimetype,g=s.filename,c=await n.sendMessage(e,{document:r,mimetype:i,fileName:g,mentions:a}),{key:l}=c;return l&&(o=l.id),`true_${e}_${t}_${o}`}return`false_${e}_${t}_${o}`}catch(e){console.log(e)}return`false_${e}_${t}_${o}`},sendLocationAsync=async(e,s,t,a)=>{let n=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,a)){const o=await a.sendMessage(e,{location:s,mentions:t});console.log(),console.log(`result: ${JSON.stringify(o)}`),console.log();const{key:r}=o;return r&&(n=r.id),`true_${e}_${s}_${n}`}return`false_${e}_${s}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${n}`},sendListAsync=async(e,s,t,a)=>{let n=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,a)){let o=[];for(const e of s.sections){let s=[];for(const t of e.rows)s.push({rowId:t.id,title:t.title,description:t.description});const t={title:e.title,rows:s};o.push(t)}const r={text:s.content,footer:s.footer,title:s.title,buttonText:s.listText,sections:o},i=await a.sendMessage(e,r,t),{key:g}=i;return g&&(n=g.id),`true_${e}_${s}_${n}`}return`false_${e}_${s}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${n}`},sendButtonAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){let r=[];for(const e of s.items){const s={buttonId:e.id,buttonText:{displayText:e.body},type:1};r.push(s)}let i=void 0;i=t?{image:{url:t},caption:s.content,footer:s.footer,buttons:r,headerType:4}:{text:s.content,footer:s.footer,buttons:r,headerType:1};const g=await n.sendMessage(e,i,a),{key:c}=g;return c&&(o=c.id),`true_${e}_${s}_${o}`}return`false_${e}_${s}_${o}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${o}`},sendButtonCTAAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){let r=[];for(const e of s.items){let s=void 0;if(e.urlButton){const t=e.urlButton;s={index:e.index,urlButton:{displayText:t.body,url:t.url}}}else if(e.callButton){const t=e.callButton;s={index:e.index,callButton:{displayText:t.body,phoneNumber:t.phoneNumber}}}else if(e.quickReplyButton){const t=e.quickReplyButton;s={index:e.index,quickReplyButton:{displayText:t.body,id:t.id}}}r.push(s)}let i=void 0;i=t?{caption:s.content,footer:s.footer,templateButtons:r,image:{url:t}}:{text:s.content,footer:s.footer,templateButtons:r};const g=await n.sendMessage(e,i,a),{key:c}=g;return c&&(o=c.id),`true_${e}_${s}_${o}`}return`false_${e}_${s}_${o}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${o}`};module.exports={sendTextAsync:sendTextAsync,replyAsync:replyAsync,sendImageAsync:sendImageAsync,sendImageFromBufferAsync:sendImageFromBufferAsync,sendDocumentAsync:sendDocumentAsync,sendDocumentFromBufferAsync:sendDocumentFromBufferAsync,sendLocationAsync:sendLocationAsync,sendListAsync:sendListAsync,sendButtonAsync:sendButtonAsync,sendButtonCTAAsync:sendButtonCTAAsync};