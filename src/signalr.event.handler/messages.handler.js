require("dotenv").config();const{SESSION_ID:SESSION_ID}=process.env,{isImage:isImage,keyExist:keyExist,findVal:findVal,msgContent:msgContent,vcardToJSON:vcardToJSON}=require("../common/common.util"),{LegacyMessageTypes:LegacyMessageTypes,getLegacyMessageType:getLegacyMessageType}=require("../common/message.type"),MessageMedia=require("../common/message.media"),{getAllMessageByContactId:getAllMessageByContactId,getUnreadMessage:getUnreadMessage}=require("../db.repository/messages.repository"),{getContactById:getContactById}=require("../db.repository/contacts.repository"),onSendMessageHandler=async(e,s)=>{const{sendTextAsync:t,replyAsync:a,sendImageAsync:n,sendImageFromBufferAsync:i,sendDocumentAsync:o,sendDocumentFromBufferAsync:g,sendLocationAsync:d,sendListAsync:c,sendButtonAsync:S,sendButtonCTAAsync:r}=require("../common/sock.util"),{signalRClient:m,serverHub:l}=require("../signalr/signalr.util"),u=JSON.parse(e),{sessionId:y,send_to:I,message:p,type:f,attachmentOrUrl:N,quotedMessageId:M,mentions:O}=u;if(y===SESSION_ID)if("image"===f){const e=(await n(I,N,p,O,s)).toString().split("_"),[t,a,i,o]=e;"false"===t&&m.connection.hub.invoke(l,"SendMessageStatus",JSON.stringify({messageStatus:{status:t,send_to:a,message:i,messageId:o},sessionId:SESSION_ID}))}else if("file"===f){const e=(await o(I,N,p,O,s)).toString().split("_"),[t,a,n,i]=e;"false"===t&&m.connection.hub.invoke(l,"SendMessageStatus",JSON.stringify({messageStatus:{status:t,send_to:a,message:n,messageId:i},sessionId:SESSION_ID}))}else if("url"===f){const e=await MessageMedia.fromUrl(N),t=e.data,a=e.mimetype;if(isImage(a)){const e=(await i(I,t,p,O,s)).toString().split("_"),[a,n,o,g]=e;"false"===a&&m.connection.hub.invoke(l,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:o,messageId:g},sessionId:SESSION_ID}))}else{const t=(await g(I,e,p,O,s)).toString().split("_"),[a,n,i,o]=t;"false"===a&&m.connection.hub.invoke(l,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}}else if("location"===f){const e=JSON.parse(p),t={degreesLatitude:e.latitude,degreesLongitude:e.longitude,name:e.description},a=(await d(I,t,O,s)).toString().split("_"),[n,i,o,g]=a;"false"===n&&m.connection.hub.invoke(l,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:g},sessionId:SESSION_ID}))}else if("list"===f){const e=JSON.parse(p),t=(await c(I,e,O,s)).toString().split("_"),[a,n,i,o]=t;"false"===a&&m.connection.hub.invoke(l,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}else if("button"===f){const e=JSON.parse(p);let t=void 0;const a=(t=keyExist(e,"urlButton")||keyExist(e,"callButton")||keyExist(e,"quickReplyButton")?await r(I,e,N,O,s):await S(I,e,N,O,s)).toString().split("_"),[n,i,o,g]=a;"false"===n&&m.connection.hub.invoke(l,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:g},sessionId:SESSION_ID}))}else{let e="";const n=(e=M?await a(I,p,M,s):await t(I,p,O,s)).toString().split("_"),[i,o,g,d]=n;"false"===i&&m.connection.hub.invoke(l,"SendMessageStatus",JSON.stringify({messageStatus:{status:i,send_to:o,message:g,messageId:d},sessionId:SESSION_ID}))}},onBroadcastMessageHandler=async(e,s,t)=>{const{sendTextAsync:a,replyAsync:n,sendImageAsync:i,sendImageFromBufferAsync:o,sendDocumentAsync:g,sendDocumentFromBufferAsync:d,sendLocationAsync:c,sendListAsync:S,sendButtonAsync:r,sendButtonCTAAsync:m}=require("../common/sock.util"),{signalRClient:l,serverHub:u}=require("../signalr/signalr.util"),{asyncForEach:y,waitFor:I}=require("../common/common.util"),p=JSON.parse(e);await y(p,async e=>{const{sessionId:n,send_to:y,message:p,type:f,attachmentOrUrl:N,mentions:M}=e;if(n===SESSION_ID){if("image"===f){const e=(await i(y,N,p,M,t)).toString().split("_"),[s,a,n,o]=e;"false"===s&&l.connection.hub.invoke(u,"SendMessageStatus",JSON.stringify({messageStatus:{status:s,send_to:a,message:n,messageId:o},sessionId:SESSION_ID}))}else if("file"===f){const e=(await g(y,N,p,M,t)).toString().split("_"),[s,a,n,i]=e;"false"===s&&l.connection.hub.invoke(u,"SendMessageStatus",JSON.stringify({messageStatus:{status:s,send_to:a,message:n,messageId:i},sessionId:SESSION_ID}))}else if("url"===f){const e=await MessageMedia.fromUrl(N),s=e.data,a=e.mimetype;if(isImage(a)){const e=(await o(y,s,p,M,t)).toString().split("_"),[a,n,i,g]=e;"false"===a&&l.connection.hub.invoke(u,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:g},sessionId:SESSION_ID}))}else{const s=(await d(y,e,p,M,t)).toString().split("_"),[a,n,i,o]=s;"false"===a&&l.connection.hub.invoke(u,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}}else if("location"===f){const e=JSON.parse(p),s={degreesLatitude:e.latitude,degreesLongitude:e.longitude,name:e.description},a=(await c(y,s,M,t)).toString().split("_"),[n,i,o,g]=a;"false"===n&&l.connection.hub.invoke(u,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:g},sessionId:SESSION_ID}))}else if("list"===f){const e=JSON.parse(p),s=(await S(y,e,M,t)).toString().split("_"),[a,n,i,o]=s;"false"===a&&l.connection.hub.invoke(u,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}else if("button"===f){const e=JSON.parse(p);let s=void 0;const a=(s=keyExist(e,"urlButton")||keyExist(e,"callButton")||keyExist(e,"quickReplyButton")?await m(y,e,N,M,t):await r(y,e,N,M,t)).toString().split("_"),[n,i,o,g]=a;"false"===n&&l.connection.hub.invoke(u,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:g},sessionId:SESSION_ID}))}else{const e=(await a(y,p,M,t)).toString().split("_"),[s,n,i,o]=e;"false"===s&&l.connection.hub.invoke(u,"SendMessageStatus",JSON.stringify({messageStatus:{status:s,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}await I(s)}})},onGetUnreadMessageHandler=async(e,s,t)=>{const{signalRClient:a,serverHub:n}=require("../signalr/signalr.util"),i=JSON.parse(e),{sessionId:o,limit:g}=i;if(o!==SESSION_ID)return;let d=[];const c=await getUnreadMessage(g||100);for(const e of c){const i=JSON.parse(e.message);if(!i.message)continue;if(i.key&&"status@broadcast"==i.key.remoteJid)continue;const o=i.key.fromMe,g=getLegacyMessageType(i),c=i.key.remoteJid.endsWith("@g.us");if(!o&&!c)try{await t.chatModify({markRead:!0,lastMessages:[i]},i.key.remoteJid)}catch(e){console.log(`markRead::ex: ${e}`)}const S=findVal(i,"messageTimestamp"),r=msgContent(g,i),m=i.key.remoteJid;let l=void 0;try{l=await getContactById(m)}catch(e){console.log(`getContactById::ex: ${e}`)}let u=void 0;if(c)try{u=await getContactById(i.key.participant)}catch(e){console.log(`getContactById::ex: ${e}`)}let y=void 0;if(g===LegacyMessageTypes.LOCATION_MESSAGE){const{locationMessage:e}=i.message;y={latitude:e.degreesLatitude,longitude:e.degreesLongitude,description:e.name}}let I=void 0,p=void 0;g===LegacyMessageTypes.BUTTONS_RESPONSE_MESSAGE?I=findVal(i,"selectedButtonId"):g===LegacyMessageTypes.LIST_RESPONSE_MESSAGE&&(p=findVal(i,"selectedRowId"));let f=s,N=m;o||(f=m,N=s);const M={id:i.key.id,sessionId:SESSION_ID,content:r||"",type:g||"",from:f||"",to:N||"",sender:c?void 0:{id:l.id?l.id:"",name:l.name?l.name:"",shortName:"",pushname:l.pushName?l.pushName:""},group:c?{id:l.id?l.id:"",name:l.name?l.name:"",sender:{id:u.id?u.id:"",name:u.name?u.name:"",shortName:"",pushname:u.pushName?u.pushName:""}}:void 0,unixTimestamp:S||0,filename:"",location:y,vcards:g===LegacyMessageTypes.CONTACT_MESSAGE||g===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE?[]:void 0,selectedButtonId:I,selectedRowId:p};if(g!==LegacyMessageTypes.CONTACT_MESSAGE&&g!==LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE&&g!==LegacyMessageTypes.LOCATION_MESSAGE||(M.content=""),g===LegacyMessageTypes.CONTACT_MESSAGE){const{vcard:e}=i.message.contactMessage;M.vcards.push(vcardToJSON(e))}if(g===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE){const{contacts:e}=i.message.contactsArrayMessage;for(const s of e)M.vcards.push(vcardToJSON(s.vcard))}d.push(M),50===d.length&&(a.connection.hub.invoke(n,"ReceiveMessages",JSON.stringify({messages:d,sessionId:SESSION_ID})),d=[])}d.push({id:"status@broadcast",type:"chat",content:"",sessionId:SESSION_ID}),d.length>0&&(a.connection.hub.invoke(n,"ReceiveMessages",JSON.stringify({messages:d,sessionId:SESSION_ID})),d=[])},onGetAllMessageHandler=async(e,s)=>{const{signalRClient:t,serverHub:a}=require("../signalr/signalr.util"),n=JSON.parse(e),{sessionId:i,phoneNumber:o,limit:g}=n;if(i!==SESSION_ID)return;let d=[];if(o){const e=await getAllMessageByContactId(o,g);for(const n of e){const e=JSON.parse(n.message);if(!e.message)continue;if(e.key&&"status@broadcast"==e.key.remoteJid)continue;const i=e.key.fromMe,o=getLegacyMessageType(e),g=e.key.remoteJid.endsWith("@g.us"),c=findVal(e,"messageTimestamp"),S=msgContent(o,e),r=e.key.remoteJid;let m=void 0;try{m=await getContactById(r)}catch(e){console.log(`getContactById::ex: ${e}`)}let l=void 0;if(g)try{l=await getContactById(e.key.participant)}catch(e){console.log(`getContactById::ex: ${e}`)}let u=void 0;if(o===LegacyMessageTypes.LOCATION_MESSAGE){const{locationMessage:s}=e.message;u={latitude:s.degreesLatitude,longitude:s.degreesLongitude,description:s.name}}let y=void 0,I=void 0;o===LegacyMessageTypes.BUTTONS_RESPONSE_MESSAGE?y=findVal(e,"selectedButtonId"):o===LegacyMessageTypes.LIST_RESPONSE_MESSAGE&&(I=findVal(e,"selectedRowId"));let p=s,f=r;i||(p=r,f=s);const N={id:e.key.id,sessionId:SESSION_ID,content:S||"",type:o||"",from:p||"",to:f||"",sender:g?void 0:{id:m.id?m.id:"",name:m.name?m.name:"",shortName:"",pushname:m.pushName?m.pushName:""},group:g?{id:m.id?m.id:"",name:m.name?m.name:"",sender:{id:l.id?l.id:"",name:l.name?l.name:"",shortName:"",pushname:l.pushName?l.pushName:""}}:void 0,unixTimestamp:c||0,filename:"",location:u,vcards:o===LegacyMessageTypes.CONTACT_MESSAGE||o===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE?[]:void 0,selectedButtonId:y,selectedRowId:I};if(o!==LegacyMessageTypes.CONTACT_MESSAGE&&o!==LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE&&o!==LegacyMessageTypes.LOCATION_MESSAGE||(N.content=""),o===LegacyMessageTypes.CONTACT_MESSAGE){const{vcard:s}=e.message.contactMessage;N.vcards.push(vcardToJSON(s))}if(o===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE){const{contacts:s}=e.message.contactsArrayMessage;for(const e of s)N.vcards.push(vcardToJSON(e.vcard))}d.push(N),50===d.length&&(t.connection.hub.invoke(a,"ReceiveMessages",JSON.stringify({messages:d,sessionId:SESSION_ID})),d=[])}d.push({id:"status@broadcast",type:"chat",content:"",sessionId:SESSION_ID}),d.length>0&&(t.connection.hub.invoke(a,"ReceiveMessages",JSON.stringify({messages:d,sessionId:SESSION_ID})),d=[])}};module.exports={onSendMessageHandler:onSendMessageHandler,onBroadcastMessageHandler:onBroadcastMessageHandler,onGetUnreadMessageHandler:onGetUnreadMessageHandler,onGetAllMessageHandler:onGetAllMessageHandler};