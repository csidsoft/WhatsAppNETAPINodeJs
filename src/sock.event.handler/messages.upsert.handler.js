require("dotenv").config();const{SESSION_ID:SESSION_ID,IMAGE_AND_DOCUMENT_PATH:IMAGE_AND_DOCUMENT_PATH}=process.env,{downloadContentFromMessage:downloadContentFromMessage}=require("@adiwajshing/baileys"),mime=require("mime-types"),fs=require("fs"),{addEditContact:addEditContact,getContactById:getContactById}=require("../db.repository/contacts.repository"),{addMessage:addMessage}=require("../db.repository/messages.repository"),{LegacyMessageTypes:LegacyMessageTypes,getLegacyMessageType:getLegacyMessageType}=require("../common/message.type"),{vcardToJSON:vcardToJSON,findVal:findVal,msgContent:msgContent,keyExist:keyExist}=require("../common/common.util"),{saveMediaToFile:saveMediaToFile,saveStream:saveStream}=require("./messages.upsert.extention"),{signalRClient:signalRClient,serverHub:serverHub}=require("../signalr/signalr.util"),messagesUpsert=async(e,s,a)=>{const t=e.messages[0];if(!t.message)return;if(t.key&&"status@broadcast"==t.key.remoteJid)return;console.log(),console.log(`incomingMsg: ${JSON.stringify(t)}`),console.log();const o=t.key.fromMe,n=getLegacyMessageType(t);console.log(`messageType: ${n}`),console.log();try{await addMessage(t)}catch(e){console.log(`addMessage::ex: ${e}`)}const i=t.key.remoteJid.endsWith("@g.us");if(!o&&!i)try{await a.chatModify({markRead:!0,lastMessages:[t]},t.key.remoteJid)}catch(e){console.log(`markRead::ex: ${e}`)}if(o&&!i){const e="true",s=t.key.remoteJid,a=t.key.id;let o=void 0;if(n===LegacyMessageTypes.CONVERSATION&&!(o=findVal(t,"conversation"))){const e=findVal(t,"extendedTextMessage");e&&(o=e.text)}return void signalRClient.connection.hub.invoke(serverHub,"SendMessageStatus",JSON.stringify({messageStatus:{status:e,send_to:s,message:o,messageId:a},sessionId:SESSION_ID}))}if(!i){const e=createContactFromMsg(t);try{await addEditContact(e)}catch(e){console.log(`call addEditContact::ex: ${e}`)}}const c=findVal(t,"messageTimestamp"),d=msgContent(n,t);let g="";if(msgHasMedia(n)&&IMAGE_AND_DOCUMENT_PATH){const e=findVal(t,"mimetype");g=`${c}.${mime.extension(e)}`,saveMedia(t,n,g)}const r=t.key.remoteJid;let m=void 0;try{m=await getContactById(r)}catch(e){console.log(`getContactById::ex: ${e}`)}let M=void 0;if(i)try{const e=o?t.participant:t.key.participant;M=await getContactById(e)}catch(e){console.log(`getContactById::ex: ${e}`)}console.log;let y=void 0;if(n===LegacyMessageTypes.LOCATION_MESSAGE){const{locationMessage:e}=t.message;y={latitude:e.degreesLatitude,longitude:e.degreesLongitude,description:e.name}}let l=void 0,T=void 0;n===LegacyMessageTypes.BUTTONS_RESPONSE_MESSAGE?(l=findVal(t,"selectedButtonId"))||(l=findVal(t,"selectedId")):n===LegacyMessageTypes.LIST_RESPONSE_MESSAGE&&(T=findVal(t,"selectedRowId"));let S=s,E=r;o||(S=r,E=s);const A={id:t.key.id,sessionId:SESSION_ID,content:d||"",type:n||"",from:S||"",to:E||"",sender:i?void 0:{id:m.id?m.id:"",name:m.name?m.name:"",shortName:"",pushname:m.pushName?m.pushName:""},group:i?{id:m.id?m.id:"",name:m.name?m.name:"",sender:{id:M.id?M.id:"",name:M.name?M.name:"",shortName:"",pushname:M.pushName?M.pushName:""}}:void 0,unixTimestamp:c||0,filename:g,location:y,vcards:n===LegacyMessageTypes.CONTACT_MESSAGE||n===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE?[]:void 0,vcardFilenames:n===LegacyMessageTypes.CONTACT_MESSAGE||n===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE?[]:void 0,selectedButtonId:l,selectedRowId:T};if(n!==LegacyMessageTypes.CONTACT_MESSAGE&&n!==LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE&&n!==LegacyMessageTypes.LOCATION_MESSAGE||(A.content=""),n===LegacyMessageTypes.CONTACT_MESSAGE){const{vcard:e}=t.message.contactMessage;saveContactMessage(e,A)}if(n===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE){const{contacts:e}=t.message.contactsArrayMessage;saveContactMessages(e,A)}signalRClient.connection.hub.invoke(serverHub,"ReceiveMessage",JSON.stringify({message:A,sessionId:SESSION_ID}))},createContactFromMsg=e=>{const s=e.key.remoteJid,a={id:s||"",name:e.pushName?e.pushName:"",pushname:"",verifiedname:"",isgroup:s.endsWith("@g.us")?1:0};return!a.name&&a.pushname&&(a.name=a.pushname?a.pushname:"",a.pushname=""),a},msgHasMedia=e=>{try{return e===LegacyMessageTypes.IMAGE_MESSAGE||e===LegacyMessageTypes.DOCUMENT_MESSAGE||e===LegacyMessageTypes.AUDIO_MESSAGE||e===LegacyMessageTypes.VIDEO_MESSAGE}catch(e){}return!1},saveMedia=async(e,s,a)=>{let t=void 0;switch(s){case LegacyMessageTypes.IMAGE_MESSAGE:try{t=await downloadContentFromMessage(e.message.imageMessage,"image")}catch(e){console.log(`downloadImage::ex: ${e}`)}break;case LegacyMessageTypes.DOCUMENT_MESSAGE:try{t=await downloadContentFromMessage(e.message.documentMessage,"document")}catch(e){console.log(`downloadDocument::ex: ${e}`)}break;case LegacyMessageTypes.AUDIO_MESSAGE:try{t=await downloadContentFromMessage(e.message.audioMessage,"audio")}catch(e){console.log(`downloadAudio::ex: ${e}`)}break;case LegacyMessageTypes.VIDEO_MESSAGE:try{t=await downloadContentFromMessage(e.message.videoMessage,"video")}catch(e){console.log(`downloadVideo::ex: ${e}`)}}t&&await saveStream(IMAGE_AND_DOCUMENT_PATH,a,t)},saveContactMessage=(e,s)=>{if(e&&(s.vcards.push(vcardToJSON(e)),IMAGE_AND_DOCUMENT_PATH)){const{fn:a}=s.vcards[0],t=`${s.unixTimestamp}_${a}.vcf`;s.vcardFilenames.push(t),saveMediaToFile(IMAGE_AND_DOCUMENT_PATH,t,e)}},saveContactMessages=(e,s)=>{let a=0;for(const t of e){if(s.vcards.push(vcardToJSON(t.vcard)),IMAGE_AND_DOCUMENT_PATH){const{fn:e}=s.vcards[a],o=`${s.unixTimestamp}_${e}.vcf`;s.vcardFilenames.push(o),saveMediaToFile(IMAGE_AND_DOCUMENT_PATH,o,t.vcard)}a++}};module.exports=messagesUpsert;